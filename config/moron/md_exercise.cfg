[gcode_macro MD_EXERCISE]
gcode:
  {% set repeat = params.REPEAT|default(1)|int %}
  {% set repeat_fan = params.REPEAT_FAN|default(0)|int %}
  {% set repeat_x = params.REPEAT_X|default(6)|int %}
  {% set repeat_y = params.REPEAT_Y|default(6)|int %}
  {% set repeat_c = params.REPEAT_CIRCLE|default(3)|int %}
  {% set repeat_cr = params.REPEAT_CORNER|default(6)|int %}
  {% set repeat_small_x = params.REPEAT_SMALL_X|default(6)|int %}
  {% set repeat_small_y = params.REPEAT_SMALL_Y|default(6)|int %}
  {% set repeat_small_c = params.REPEAT_SMALL_CIRCLE|default(3)|int %}
  {% set repeat_z = params.REPEAT_Z|default(6)|int %}
  {% set edge = params.EDGE|default(20)|int %}
  {% set max_velocity = params.SPEED_XY|default(0)|int %}
  {% set max_z_velocity = params.SPEED_Z|default(0)|int %}
  {% set x_min = printer.configfile.settings['stepper_x'].position_min + edge %}
  {% set x_max = printer.configfile.settings['stepper_x'].position_max - edge %}
  {% set x_mid = ( printer.configfile.settings['stepper_x'].position_max + printer.configfile.settings['stepper_x'].position_min ) / 2 %}
  {% set y_min = printer.configfile.settings['stepper_x'].position_min + edge %}
  {% set y_max = printer.configfile.settings['stepper_x'].position_max - edge %}
  {% set y_mid = ( printer.configfile.settings['stepper_x'].position_max + printer.configfile.settings['stepper_x'].position_min ) / 2 %}
  {% set z_home = printer.configfile.settings['stepper_z'].position_min + 12 %}
  {% set z_min = printer.configfile.settings['stepper_z'].position_min + edge %}
  {% set z_max = printer.configfile.settings['stepper_z'].position_max - edge %}

  RESPOND MSG="x: {x_min} -> {x_mid} <- {x_max}"
  RESPOND MSG="y: {y_min} -> {y_mid} <- {y_max}"
  
  {% if max_velocity<=0 %}
    {% set max_velocity = printer.configfile.settings['printer'].max_velocity * 60 %}
  {% else %}  
    {% set max_velocity = max_velocity * 60 %}
  {% endif %}

  {% if max_z_velocity<=0 %}
    {% set max_z_velocity = printer.configfile.settings['printer'].max_z_velocity * 60 %}
  {% else %}  
    {% set max_z_velocity = max_z_velocity * 60 %}
  {% endif %}

  {% if printer.toolhead.homed_axes != "xyz" %}
    G28
    QUAD_GANTRY_LEVEL
  {% endif %}

  {% for r in range(repeat) %}
    G90  
    G1 X{x_mid} Y{y_mid} Z{z_home} F{max_velocity / 2}
  
    {% if repeat_fan > 0 %}
      {% for i in range(repeat_fan) %}
        M106 S255
        G4 P800
        M106 S0
        G4 P200
      {% endfor %}
    {% endif %}
  
    {% if repeat_y > 0 %}
      G1 X{x_mid} Y{y_mid} F{max_velocity}
      {% for i in range(repeat_y) %}
        G1 Y{y_min} F{max_velocity}
        G1 Y{y_max} F{max_velocity}
      {% endfor %}
    {% endif %}
  
    {% if repeat_x > 0 %}
      G1 X{x_mid} Y{y_mid} F{max_velocity}
      {% for i in range(repeat_x) %}
        G1 X{x_min} F{max_velocity}
        G1 X{x_max} F{max_velocity}
      {% endfor %}
    {% endif %}
   
    {% if repeat_c > 0 %}
      G1 X{x_mid/2} Y{y_mid} F{max_velocity}
      {% for i in range(repeat_c) %}
        G2 X{3*x_mid/2} Y{y_mid} I{x_mid/2} J0 F{max_velocity}
        G2 X{x_mid/2} Y{y_mid} I{0-x_mid/2} J0 F{max_velocity}
      {% endfor %}  
    {% endif %}

    {% if repeat_cr > 0 %}
      G1 X{x_mid} Y{y_mid} F{max_velocity}
      {% for i in range(repeat_cr) %}
        G1 X{x_min - edge} Y{y_max + edge} F{max_velocity}
        G1 X{x_max + edge} Y{y_min - edge} F{max_velocity}
      {% endfor %}
      G1 X{x_mid} Y{y_mid} F{max_velocity}
      {% for i in range(repeat_cr) %}
        G1 X{x_max + edge} Y{y_max + edge} F{max_velocity}
        G1 X{x_min - edge} Y{y_min - edge} F{max_velocity}
      {% endfor %}
    {% endif %}    
  
    {% if repeat_small_y > 0 %}
      {% for i in range(repeat_small_y) %}
        G1 X{x_mid} Y{y_mid-(y_mid/12)} F{max_velocity}
        G1 X{x_mid} Y{y_mid+(y_mid/12)} F{max_velocity}
      {% endfor %}
    {% endif %}
  
    {% if repeat_small_x > 0 %}
      G1 X{x_mid} Y{y_mid} F{max_velocity}
      {% for i in range(repeat_small_x) %}
        G1 X{x_mid-(x_mid/12)} Y{y_mid} F{max_velocity}
        G1 X{x_mid+(x_mid/12)} Y{y_mid} F{max_velocity}
      {% endfor %}
    {% endif %}
  
    {% if repeat_small_c > 0 %}
      G1 X{x_mid - (x_mid/12)} Y{y_mid} F{max_velocity}
      {% for i in range(repeat_small_c) %}
        G2 X{x_mid + (x_mid/12)} Y{y_mid} I{x_mid/12} J0 F{max_velocity}
        G2 X{x_mid - (x_mid/12)} Y{y_mid} I{0-x_mid/12} J0 F{max_velocity}
      {% endfor %}  
    {% endif %}
  
    {% if repeat_z > 0 %}
      G1 X{x_mid} Y{y_mid} F{max_velocity}
      {% for i in range(repeat_z) %}
        G1 Z{z_max} F{max_z_velocity}
        G1 Z{z_min} F{max_z_velocity}
      {% endfor %}
      G1 Z{z_home} F{max_z_velocity/12} 
    {% endif %}
  {% endfor %}
  G1 X{x_mid} Y{y_mid} F{max_velocity}
  G1 Z{z_home} F{max_z_velocity/12} 
